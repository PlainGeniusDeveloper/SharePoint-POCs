<script type="text/javascript">
    function addCustomRibbonAction() {
        var ribbonMenu = document.getElementById('Ribbon.EditingTools.CPInsert');
        if (ribbonMenu && !document.getElementById('customTableInsertDropdown')) {
            var li = document.createElement('li');
            li.className = 'ms-cui-ctl-li';
            li.innerHTML = `
                <div class="ms-cui-ctl-large">
                    <a class="ms-cui-ctl-largeAnchor" href="#" id="customTableInsertDropdown" title="Insert Predefined Table">
                        <span class="ms-cui-img-16by16 ms-cui-img-cont-float">
                            <img src="https://yoursharepointsite.com/path/to/icon.png" alt="Insert Table" />
                        </span>
                        <span class="ms-cui-ctl-largeLabel">Insert Table</span>
                    </a>
                    <div class="dropdown-content">
                        <a href="#" data-table-url="https://yoursharepointsite.com/path/to/tableTemplate1.html">Table 1</a>
                        <a href="#" data-table-url="https://yoursharepointsite.com/path/to/tableTemplate2.html">Table 2</a>
                        <a href="#" data-table-url="https://yoursharepointsite.com/path/to/tableTemplate3.html">Table 3</a>
                    </div>
                </div>
            `;
            ribbonMenu.appendChild(li);

            var dropdown = document.querySelector('#customTableInsertDropdown');
            dropdown.addEventListener('click', function(event) {
                event.preventDefault();
                dropdown.nextElementSibling.classList.toggle('show');
            });

            var options = document.querySelectorAll('.dropdown-content a');
            options.forEach(option => {
                option.addEventListener('click', function(event) {
                    event.preventDefault();
                    insertTable(this.getAttribute('data-table-url'));
                });
            });

            console.log("Custom dropdown added successfully.");
        }
    }

    function insertTable(tableHtmlUrl) {
        fetch(tableHtmlUrl)
            .then(response => response.text())
            .then(data => {
                var richTextField = document.querySelector('.ms-rtestate-field');
                if (richTextField) {
                    insertHTMLAtCursor(richTextField, data);
                } else {
                    alert("Rich text field not found!");
                }
            })
            .catch(error => {
                console.error('Error loading the table template:', error);
            });
    }

    function insertHTMLAtCursor(el, html) {
        el.focus();
        if (document.selection) {
            var sel = document.selection.createRange();
            sel.pasteHTML(html);
        } else if (window.getSelection) {
            var sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                var range = sel.getRangeAt(0);
                range.deleteContents();
                var frag = document.createDocumentFragment();
                var temp = document.createElement('div');
                temp.innerHTML = html;
                while (temp.firstChild) {
                    frag.appendChild(temp.firstChild);
                }
                range.insertNode(frag);
                range.collapse(false);
            }
        }
    }

    function observeRibbon() {
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                var insertTitle = document.getElementById('Ribbon.EditingTools.CPInsert-Title');
                if (insertTitle) {
                    captureInsertTitleClick();
                }
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
    }

    function captureInsertTitleClick() {
        var insertTitle = document.getElementById('Ribbon.EditingTools.CPInsert-Title');
        if (insertTitle) {
            insertTitle.addEventListener('click', function() {
                setTimeout(addCustomRibbonAction, 500);
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        observeRibbon();
    });
</script>

<style>
    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
    }
    .dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }
    .dropdown-content a:hover {
        background-color: #f1f1f1;
    }
    .show {
        display: block;
    }
</style>
