<script type="text/javascript">
    function addCustomRibbonAction() {
        // Check if the ribbon is available
        var ribbonMenu = document.getElementById('Ribbon.EditingTools.CPInsert');
        if (ribbonMenu) {
            // Create a new list item for the custom action
            var newItem = document.createElement('li');
            newItem.innerHTML = `
                <a href="#" id="customTableInsertButton" class="ms-cui-ctlms-d" title="Insert Predefined Table">
                    <img src="https://yoursharepointsite.com/path/to/icon.png" alt="Insert Table" />
                    <span class="ms-cui-ctlms-d" id="customTableInsertButtonLabel">Insert Table</span>
                </a>
            `;

            // Add the new item to the ribbon menu
            ribbonMenu.appendChild(newItem);

            // Attach click event to the new button
            document.getElementById('customTableInsertButton').addEventListener('click', function(event) {
                event.preventDefault();
                insertTable(); // Call the function to insert the table
            });
        } else {
            console.error('Ribbon menu not found.');
        }
    }

    // Function to insert table (defined previously)
    function insertTable() {
        var tableHtmlUrl = "https://yoursharepointsite.com/path/to/tableTemplate.html"; // Replace with your HTML file URL
        
        fetch(tableHtmlUrl)
            .then(response => response.text())
            .then(data => {
                var richTextField = document.querySelector('.ms-rtestate-field'); // Adjust selector as per your form field
                if (richTextField) {
                    insertHTMLAtCursor(richTextField, data);
                } else {
                    alert("Rich text field not found!");
                }
            })
            .catch(error => {
                console.error('Error loading the table template:', error);
            });
    }

    function insertHTMLAtCursor(el, html) {
        var range, sel;
        if (window.getSelection) {
            sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                range = sel.getRangeAt(0);
                range.deleteContents();
                var fragment = range.createContextualFragment(html);
                range.insertNode(fragment);
                range.collapse(false);
            }
        } else if (document.selection && document.selection.createRange) {
            document.selection.createRange().pasteHTML(html);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Delay execution to ensure ribbon is loaded
        setTimeout(addCustomRibbonAction, 1000); // Adjust timeout as needed
    });
</script>
