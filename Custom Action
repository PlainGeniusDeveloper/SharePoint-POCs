<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        console.log("Document ready. Waiting for SP.js and SP.Ribbon.js to load...");
        SP.SOD.executeFunc('sp.js', 'SP.ClientContext', function() {
            console.log("SP.js loaded.");
            SP.SOD.executeFunc('sp.ribbon.js', 'SP.Ribbon.PageManager', function() {
                console.log("SP.Ribbon.js loaded.");
                ensureRibbon();
            });
        });
    });

    function ensureRibbon() {
        console.log("Ensuring ribbon is available...");
        var ribbon = SP.Ribbon.PageManager.get_instance().get_ribbon();
        if (!ribbon) {
            console.log("Ribbon not available yet. Waiting...");
            setTimeout(ensureRibbon, 500); // Wait and check again
        } else {
            console.log("Ribbon is available. Customizing...");
            customizeRibbon();
        }
    }

    function customizeRibbon() {
        var ribbonData = `
            <CommandUIExtension xmlns="http://schemas.microsoft.com/sharepoint/">
                <CommandUIDefinitions>
                    <CommandUIDefinition Location="Ribbon.ListForm.New.Controls._children">
                        <Button Id="Ribbon.ListForm.New.CustomGroup.CustomButton"
                            Command="CustomButtonCommand"
                            Sequence="1000"
                            Image16by16="/_layouts/15/images/placeholder16x16.png"
                            Image32by32="/_layouts/15/images/placeholder32x32.png"
                            LabelText="Custom Button"
                            TemplateAlias="o1"/>
                    </CommandUIDefinition>
                </CommandUIDefinitions>
                <CommandUIHandlers>
                    <CommandUIHandler Command="CustomButtonCommand" CommandAction="javascript:customButtonAction();" />
                </CommandUIHandlers>
            </CommandUIExtension>`;

        var ribbonPageComponent = new SP.Ribbon.PageComponent({
            id: 'CustomRibbonPageComponent',
            init: function() {},
            getFocusedCommands: function() {
                return ['CustomButtonCommand'];
            },
            getGlobalCommands: function() {
                return ['CustomButtonCommand'];
            },
            canHandleCommand: function(commandId) {
                return commandId === 'CustomButtonCommand';
            },
            handleCommand: function(commandId, properties, sequence) {
                if (commandId === 'CustomButtonCommand') {
                    customButtonAction();
                }
            }
        });

        SP.Ribbon.PageManager.get_instance().addPageComponent(ribbonPageComponent);
        SP.Ribbon.PageManager.get_instance().get_ribbon().addExtension(ribbonData);
        console.log("Custom button added to ribbon.");
    }

    function customButtonAction() {
        alert('Custom button clicked!');
    }
</script>
