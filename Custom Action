<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        console.log("Document ready. Waiting for SP.js and SP.Ribbon.js to load...");
        SP.SOD.executeFunc('sp.js', 'SP.ClientContext', function() {
            console.log("SP.js loaded.");
            SP.SOD.executeFunc('sp.ribbon.js', 'SP.Ribbon.PageManager', function() {
                console.log("SP.Ribbon.js loaded.");
                ensureRibbon();
            });
        });
    });

    function ensureRibbon() {
        console.log("Ensuring ribbon is available...");
        var ribbon = SP.Ribbon.PageManager.get_instance().get_ribbon();
        if (!ribbon) {
            console.log("Ribbon not available yet. Waiting...");
            setTimeout(ensureRibbon, 500); // Wait and check again
        } else {
            console.log("Ribbon is available. Adding custom button...");
            addCustomButton();
        }
    }

    function addCustomButton() {
        // Use ribbon instance to add custom button
        var ribbon = SP.Ribbon.PageManager.get_instance().get_ribbon();
        var newItemTab = ribbon.get_childById('Ribbon.ListForm.Edit'); // Ensure this ID is correct for New Item form

        if (newItemTab) {
            // Create custom button
            var customButton = {
                id: "CustomButton",
                title: "Custom Button",
                description: "Click to perform custom action",
                command: "CustomButtonCommand",
                image16by16: "/_layouts/15/images/placeholder16x16.png",
                image32by32: "/_layouts/15/images/placeholder32x32.png",
                sequence: 1000,
                templateAlias: "o1"
            };

            // Add button to the ribbon
            var commandUIExtension = `
                <CommandUIExtension xmlns="http://schemas.microsoft.com/sharepoint/">
                    <CommandUIDefinitions>
                        <CommandUIDefinition Location="Ribbon.ListForm.Edit.Controls._children">
                            <Button Id="${customButton.id}"
                                Command="${customButton.command}"
                                Sequence="${customButton.sequence}"
                                Image16by16="${customButton.image16by16}"
                                Image32by32="${customButton.image32by32}"
                                LabelText="${customButton.title}"
                                TemplateAlias="${customButton.templateAlias}"/>
                        </CommandUIDefinition>
                    </CommandUIDefinitions>
                    <CommandUIHandlers>
                        <CommandUIHandler Command="${customButton.command}" CommandAction="javascript:customButtonAction();" />
                    </CommandUIHandlers>
                </CommandUIExtension>`;

            // Adding the custom action
            var customAction = SP.Ribbon.PageManager.get_instance().get_ribbon().get_customActions().add();
            customAction.set_location('CommandUI.Ribbon.ListForm.New');
            customAction.set_commandUIExtension(commandUIExtension);
            customAction.update();

            // Refresh ribbon to reflect changes
            ribbon.refresh();
            console.log("Custom button added to ribbon.");
        } else {
            console.log("New Item tab not found. Waiting...");
            setTimeout(addCustomButton, 500); // Wait and check again
        }
    }

    function customButtonAction() {
        alert('Custom button clicked!');
    }
</script>
