$(document).ready(function() {
    let editorInstance;
    let accordionEditorInstance;
    let currentRow;
    let currentAccordion;

    // Initialize CKEditor
    function initCKEditor(selector, instance) {
        // Check if the editor instance already exists
        if (instance) {
            return Promise.resolve(instance);
        }

        // Create a new editor instance if not already created
        return ClassicEditor
            .create(document.querySelector(selector), {
                toolbar: ['undo', 'redo', '|', 'bold', 'italic', '|', 'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor']
            })
            .catch(error => {
                console.error('There was an error initializing CKEditor:', error);
            });
    }

    // Show modal function
    function showModal(modalId) {
        $('.modal-backdrop').show();
        $(modalId).show();
    }

    // Hide modal function
    function hideModal() {
        $('.modal-backdrop').hide();
        $('#editor-modal').hide();
        $('#accordion-editor-modal').hide();
    }

    // Handle edit button click
    $(document).on('click', '.edit', function() {
        let parent = $(this).closest('[data-section-type]');
        let sectionType = parent.attr('data-section-type');

        if (sectionType === 'accordion') {
            currentAccordion = parent;
            $('#accordion-header').val(parent.find('.accordion-header').text().trim());

            // Initialize or reuse accordion editor
            initCKEditor('#accordion-editor', accordionEditorInstance).then(editor => {
                accordionEditorInstance = editor;
                editor.setData(parent.find('.accordion-content').html());
            });

            showModal('#accordion-editor-modal');
        } else {
            currentRow = parent;
            $('#section-title').val(currentRow.find('h3').text());

            // Initialize or reuse section editor
            initCKEditor('#editor', editorInstance).then(editor => {
                editorInstance = editor;
                editor.setData(currentRow.find('p').html());
            });

            showModal('#editor-modal');
        }
    });

    // Save button for regular sections
    $('#save-btn').on('click', function() {
        let title = $('#section-title').val();
        let content = editorInstance.getData();

        currentRow.find('h3').text(title);
        currentRow.find('p').html(content);

        hideModal();
    });

    // Save button for accordion sections
    $('#accordion-save-btn').on('click', function() {
        let header = $('#accordion-header').val();
        let content = accordionEditorInstance.getData();

        currentAccordion.find('.accordion-header').text(header);
        currentAccordion.find('.accordion-content').html(content);

        hideModal();
    });

    // Close modal when clicking outside
    $('.modal-backdrop').on('click', hideModal);
});
