$(document).ready(function() {
    var siteUrl = '/sites/yoursite';
    var configListName = 'Field Visibility Config';

    function fetchConfigData(tabValue) {
        var filterQuery = tabValue ? "?$filter=Tab eq '" + tabValue + "'" : ""; // Conditional filter query

        return $.ajax({
            url: siteUrl + "/_api/web/lists/getbytitle('" + configListName + "')/items" + filterQuery,
            type: 'GET',
            headers: {
                'Accept': 'application/json;odata=verbose'
            }
        });
    }

    function hideFields(fieldNames) {
        $.each(fieldNames, function(index, fieldName) {
            $('nobr:contains("' + fieldName + '")').closest('tr').hide();
        });
    }

    function showAllFields() {
        // Show all previously hidden fields
        $('tr').each(function() {
            if ($(this).css('display') === 'none') {
                $(this).show();
            }
        });
    }

    function applyInitialConfig() {
        fetchConfigData(null).done(function(data) {
            var results = data.d.results;
            var fieldNames = $.map(results, function(item) { return item.FieldName; });
            hideFields(fieldNames);
        }).fail(function(error) {
            console.log("Error fetching initial data: " + JSON.stringify(error));
        });
    }

    // Event handler for Select2 dropdown change
    $('select[title="Tab Required Field"]').on('select2:select', function(e) {
        var selectedTab = e.params.data.id; // Get selected tab value from Select2
        
        showAllFields(); // Show all fields before applying new rules

        // Fetch configuration data based on selected tab
        fetchConfigData(selectedTab).done(function(data) {
            var results = data.d.results;
            var fieldNames = $.map(results, function(item) { return item.FieldName; });
            hideFields(fieldNames);
        }).fail(function(error) {
            console.log("Error fetching data: " + JSON.stringify(error));
        });
    });

    // Apply initial configuration on page load
    applyInitialConfig();
});
